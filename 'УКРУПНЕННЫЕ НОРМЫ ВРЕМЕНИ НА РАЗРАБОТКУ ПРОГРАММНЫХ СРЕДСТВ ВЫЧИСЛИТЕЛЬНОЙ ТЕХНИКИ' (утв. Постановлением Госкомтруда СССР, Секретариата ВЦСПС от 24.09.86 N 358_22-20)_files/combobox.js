(function(e,t){var n=function(n,r){var i=this,s=e(n),o=false;if(n.combobox!=t){return false}n.combobox=i;i.options=r;i.element=n;i.$element=s;i.multiple=n.multiple;(i._list=(i.list=e('<ul class="'+i.options.classes.list+(i.multiple?" "+i.options.classes.multiple:"")+'" />')).get(0)).combobox=i;if(!i.multiple){(i._wrapper=(i.wrapper=e('<div class="'+i.options.classes.wrapper+'" />')).get(0)).combobox=i;(i._selected=(i.selected=e('<div class="'+i.options.classes.selected+'" />')).get(0)).combobox=i;(i._button=(i.button=e('<div class="'+i.options.classes.button+'"></div>')).get(0)).combobox=i}i.$element.bind("change",function(e){i.updateSelected()}).bind("focus",function(e){i.focus()}).bind("blur",function(e){i.blur()}).bind("keypress",function(e){switch(e.which){case 38:case 40:i.updateSelected();break}});var u=i.element.form;if(u!==null&&u.combobox_reset_processed===t){u.combobox_reset_processed=true;e(u).bind("reset",function(t){setTimeout(function(){e.each(u.elements,function(){if(this.tagName=="SELECT"&&typeof this.combobox!="undefined"){this.combobox.updateSelected()}})},1)})}if(!i.multiple){i.wrapper.bind("click",function(e){if(i.isDisabled()){return false}if(i.blocked){return false}if(i.state){i.hide()}else{if(!o){o=true;i.list.add(i.button).add(i.selected).hover(function(e){clearTimeout(i.timer)},function(e){i.timer=setTimeout(function(){i.hide()},400)})}i.show()}i.focus();return false}).bind("keydown",function(e){var t=i.$element.find("option"),n=t.index(t.filter(":selected"));switch(e.which){case 38:if(n>0){t.eq(n-1).attr("selected","selected");i.$element.change()}break;case 40:if(n<t.length){t.eq(n+1).attr("selected","selected");i.$element.change()}break}}).bind("focus",function(e){i.focus()}).bind("blur",function(e){i.blur()})}else{i.list.bind("keydown",function(e){var t=i.$element.find("option"),n=e.ctrlKey||e.metaKey,r;switch(e.which){case 38:r=t.index(t.filter(":selected").first());r=r==-1?1:r;r=r>t.length-1?t.length-1:r;if(!n){t.attr("selected",null)}t.eq(r-1).attr("selected","selected");i.$element.change();break;case 40:r=t.index(t.filter(":selected").last());r=r==-1?-1:r;r=r>=t.length-1?-1:r;if(!n){t.attr("selected",null)}t.eq(r+1).attr("selected","selected");i.$element.change();break}})}if(i.options.hoverEnabled&&!i.multiple){i.wrapper.hover(function(){i.wrapper.addClass(i.options.classes.wrapHover)},function(){if(!i.blocked&&!i.state){i.wrapper.removeClass(i.options.classes.wrapHover)}})}i.width=i.options.width?i.options.width:i.$element.outerWidth();i.height=i.options.height?i.options.height:i.$element.outerHeight();i.btnWidth=i.options.btnWidth;if(i.options.adjustWidth&&i.btnWidth>20){switch(typeof i.options.adjustWidth){case"boolean":i.width=i.width+i.options.btnWidth-20;break;case"number":i.width=i.width+i.options.adjustWidth;break}}var a=e.browser.msie&&e.browser.version.match(/^\d+/)[0]<8?"inline":"inline-block";if(!i.multiple){i.wrapper.css({display:a,width:i.width,height:i.height}).attr("tabindex",0);i.button.css({width:i.btnWidth,height:i.height,display:"inline-block"});i.selected.css({width:i.width-i.btnWidth,height:i.height,display:"inline-block"});i.list.css({width:i.width,position:"absolute"})}else{i._list.style.display=a;i._list.style.width=i.width+"px";i.list.attr("tabindex",0)}if(!i.multiple){i.wrapper.append(i.button);i.wrapper.append(i.selected);i.wrapper.insertAfter(i.$element)}else{i.list.insertAfter(i.$element)}i.updateDisabled();i.rebuild();i.updateSelected();if(!i.multiple){i._list.style.display="none";e("body").append(i.list)}i.$element.hide().trigger("combo_init")};e.extend(n.prototype,{state:false,blocked:false,timer:null,value:null,disabled:false,multiple:false,groups:false,filter:function(e,t){return t},default_options:{width:false,height:false,btnWidth:15,showSpeed:"fast",hideSpeed:"fast",hideSelected:false,listMaxHeight:false,hoverEnabled:false,forceScroll:false,adjustWidth:true,theme:"combo"},default_classes:{wrapper:"wrapper",focus:"focus",disabled:"disabled",multiple:"multiple",button:"button",group:"group",groupLabel:"group-label",list:"list",selected:"selected",itemHover:"item-hover",itemActive:"item-active",wrapHover:"wrapper-hover",wrapActive:"wrapper-active",listLong:"list-long"},rebuild:function(){var n=this,r=new Object,i="";n.groups=n.$element.find("optgroup:first").length==0?false:true;if(n.groups){n.$element.children().each(function(){switch(this.tagName){case"OPTION":r[this.index]={text:this.text,value:this.value};i+="<li>"+r[this.index].text+"</li>";break;case"OPTGROUP":var s=e(this),o=s.children("option");if(o.length>0){var u=s.attr("label");if(u!=t){i+='<li class="'+n.options.classes.groupLabel+'">'+u+"</li>"}i+='<li class="'+n.options.classes.group+'"><ul>';o.each(function(){r[this.index]={text:this.text,value:this.value};i+="<li>"+this.text+"</li>"});i+="</ul></li>"}break}})}else{n.$element.find("option").each(function(){r[this.index]={text:this.text,value:this.value};i+="<li>"+this.text+"</li>"})}n.list.html(i);var s=!n.groups?n.list.find("li"):n.list.find("li").not("."+n.options.classes.groupLabel).not("."+n.options.classes.group);s.each(function(e){this.combobox_index=e;this.combobox_value=r[e].value});if(n.options.hoverEnabled){n.list.mouseenter(function(t){if(this.mouseenter_inited===true){return}this.mouseenter_inited=true;s.hover(function(){e(this).addClass(n.options.classes.itemHover)},function(){e(this).removeClass(n.options.classes.itemHover)})})}n.list.click(function(e){var t=e.ctrlKey||e.metaKey;if(e.target.nodeName!="LI"){return}if(n.isDisabled()){return false}var r=n.$element.find("option");if(n.multiple&&t){if(r.get(e.target.combobox_index).selected==true){r.get(e.target.combobox_index).selected=false}else{r.get(e.target.combobox_index).selected=true}}else if(n.multiple&&e.shiftKey){var i=r.filter(":selected"),s=r.index(i.first()),o=e.target.combobox_index;s=s==-1?0:s;if(s>o){o=s;s=e.target.combobox_index}r.attr("selected",false).slice(s,o+1).attr("selected","selected")}else if(n.multiple){r.filter(":selected").attr("selected",null);r.eq(e.target.combobox_index).attr("selected","selected")}else{r.eq(e.target.combobox_index).attr("selected","selected")}n.$element.change();n.updateSelected();if(!n.multiple){n.hide()}n.removeSelection()});return n},updateSelected:function(){var e=this,t=!e.groups?e.list.find("li"):e.list.find("li").not("."+e.options.classes.groupLabel).not("."+e.options.classes.group),n=e.$element.find("option").filter(":selected"),r;if(!e.multiple){r=n.text();e.selected.text(typeof e.options.filter=="function"?e.options.filter("selected",r):r)}t.filter("."+e.options.classes.itemActive).removeClass(e.options.classes.itemActive);if(n.length==0){e.value=null}else{var i=n.get(0).index;if(e.multiple){e.value=[];n.each(function(){t.eq(this.index).addClass(e.options.classes.itemActive);e.value[e.value.length]=this.value})}else{e.value=n.attr("value");t.eq(n.get(0).index).addClass(e.options.classes.itemActive)}}return e},updatePosition:function(){var e=this;if(e.multiple){return false}var t=e.wrapper.offset();t={top:t.top+e.height,left:t.left};e.$element.trigger("update_position",t);e.list.css(t);return e},show:function(){var e=this;if(e.blocked){return}e.$element.trigger("before_show");if(e.options.hideSelected&&!e.multiple){$children=!e.groups?e.list.find("li"):e.list.find("li").not("."+e.options.classes.groupLabel).not("."+e.options.classes.group),$children.show();for(i=0;i<$children.length;i++){if($children.get(i).combobox_value==e.value){$children.eq(i).hide();break}}}e.blocked=true;e.wrapper.addClass(e.options.classes.wrapActive);var t=false;if(e.options.listMaxHeight){e.list.css({top:"-9999px",left:"-9999px"});if(e.list.height()>=e.options.listMaxHeight){e.list.addClass(this.options.classes.listLong);if(e.options.forceScroll){e.list.css({height:e.options.listMaxHeight,overflow:"auto"})}t=true}else{e.list.removeClass(e.options.classes.listLong)}e.list.hide();e.updatePosition();e.list.show()}else{this.updatePosition()}e.list.slideDown(e.options.showSpeed,function(){e.state=true;e.blocked=false;if(t){var n=e.list.find("."+e.options.classes.itemActive);if(n.length==1){if(e.options.hideSelected){var r=n.prev();if(r.length==0){r=n.next()}if(r.length==1){e.list.scrollTop(r.get(0).offsetTop)}}else{e.list.scrollTop(n.get(0).offsetTop)}}}});return e},hide:function(){var e=this;if(e.blocked||!e.state){return false}e.$element.trigger("before_hide");e.blocked=true;e.wrapper.removeClass(e.options.classes.wrapActive);if(e.options.hoverEnabled){e.wrapper.removeClass(e.options.classes.wrapHover)}if(e.options.hideSpeed==0){e.list.hide();e.state=false;e.blocked=false}else{e.list.slideUp(e.options.hideSpeed,function(){e.state=false;e.blocked=false})}return e},isDisabled:function(){var e=this.$element.attr("disabled");return e==="disabled"||e==true?true:false},updateDisabled:function(){var e=this;e.disabled=e.isDisabled();var t=e.multiple?e.list:e.wrapper;if(e.disabled){t.addClass(e.options.classes.disabled)}else{t.removeClass(e.options.classes.disabled)}return e.disabled},removeSelection:function(){if(window.getSelection){window.getSelection().removeAllRanges()}else if(document.selection&&document.selection.type!="None"){try{document.selection.empty()}catch(e){}}},focus:function(){if(this.wrapper!==t){this.wrapper.addClass(this.options.classes.focus)}else{this.list.addClass(this.options.classes.focus)}},blur:function(){if(this.wrapper!==t){this.wrapper.removeClass(this.options.classes.focus)}else{this.list.removeClass(this.options.classes.focus)}}});e.fn.combobox=function(t,r){t=e.extend({},n.prototype.default_options,t);t.classes=e.extend({},n.prototype.default_classes,r);e.each(t.classes,function(e,n){t.classes[e]=t.theme+"-"+n});return this.each(function(){var e=new n(this,t)})}})(jQuery)